# FEECC Cameraman

> Feecc Cameraman — микросервис, предназначенный для одновременной записи видео из нескольких RTSP-потоков по запросу
> на эндпоинт. Он предоставляет простой интерфейс REST API для запуска и завершения записи, получения информации о 
> подключенных камерах (потоки RTSP), также обрабатывает аутентификацию пользователей.

Необходимое оборудование для рабочего места инженера (далее - РМИ) перечислено в [соответствующей статье](./workbench-and-components.md).
Исходный код модуля доступен по [сслыке](https://github.com/Multi-Agent-io/feecc-cameraman).

## Стек технологий

- Операционная система - [GNU/LINUX](https://www.gnu.org/), рекомендуется [Ubuntu](https://ubuntu.com/)
- Язык программирования - [Python](https://www.python.org/)
- Утилита записи с камер - [FFMPEG](https://ffmpeg.org/)
- ASGI-сервер - [Uvicorn](https://www.uvicorn.org/)
- REST-запросы - [FastAPI](https://fastapi.tiangolo.com/)
- ПО для развертывания - [Docker](https://www.docker.com/)
- База данных - [MongoDB](https://www.mongodb.com/)

## Установка

Приложение должно запускаться в контейнере Docker и может быть настроено путем установки нескольких переменных окружения.

> Обратите внимание, что в этом руководстве предполагается хост Linux(Ubuntu), однако вы также можете запустить Cameraman
> на любой другой ОС, но имейте в виду: часовой пояс определяется из файлов хоста `/etc/timezone` и `/etc/localtime` внутри 
> контейнера, которые не присутствуют на компьютерах с Windows, в таком случае внутри контейнера будет время UTC.

Склонируйте репозиторий и измените переменные среды:
```
git clone https://github.com/Multi-Agent-io/feecc-cameraman.git
cd feecc-cameraman
vim docker-compose.yml
```

### Переменные среды

- `MONGODB_URI` — URI вашего подключения к MongoDB, заканчивающийся на `/db-name`.

- `PRODUCTION_ENVIRONMENT` - Оставьте `null`, если вы хотите провести тестирование учетных данных для работы, иначе `True`.

- `FFMPEG_COMMAND` - Команда для записи потока с помощью камеры.

- `CAMERAS_CONFIG` — Строка в формате JSON для конфигурации камеры. Представляет собой список строк в формате JSON, 
каждая из которых описывает параметры RTSP (разделенные символом "-" номер потока, сокет и URI). Пример:
```
'["1-192.168.88.239:554-rtsp://login:password@192.168.88.239:554/Streaming/Channels/101"]'
```
По окончании конфигурации, соберите и запустите контейнер с помощью docker-compose. 
```
sudo docker-compose up --build
```

Проверьте развертывание, перейдя по адресу http://127.0.0.1:8081/docs в браузере. Вы должны увидеть страницу спецификации SwaggerUI API.

## Описание модуля

### Эндпоинты

Работа модуля заключается в обработке запросов к соответствующим эндпоинтам:

###### `GET` /cameras
> Возвращает список всех присоединенных камер

###### `GET` /records
> Возвращает список всех сделанных записей

###### `POST` /camera/{camera_number}/start
> Начало записи видео камерой с соответствующим номером {camera_number}

###### `POST` /record/{record_id}/stop
> Остановка записи видео камерой с соответствующим номером {camera_number}

На старте модуль проверят "зависшие записи", а также получает доступ к БД. По завершении проверяет и останавливает текущие
записи.

### Подмодули

Подмодуль `auth` отвечает за авторизацию пользователя, обращения к базе данных, а также за то, чтобы к камере был привязан
только один рабочий в каждый момент времени

Подмодуль `feecc_cameraman` отвечает непосредственно за взаимодействие с камерой:

  - `camera.py` описывает функции проверки доступности камеры, функции начала, остановки и проверки активности записей.
  - `dependencies.py` описывает утилиты получения номера камеры и номера записи.
  - `models.py` описывает модели ответов на запросы.
  - `utils.py` отвечает за завершение "зависших записей".

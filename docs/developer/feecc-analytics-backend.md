# Analytics

> Модуль аналитики отвечает за предоставление сотрудникам ОТК сервисов проверки выполнения производственных этапов.
> Аутентификация сотрудников отдела осуществляется с помощью логина и пароля по oauth2. Также данный сервис 
> предоставляет доступ к возможности редактирования схем производства - ProductionSchemas. 

[//]: # (TODO Коля, посмотри! Мб сравнить с Cameraman, там небольшое интро есть.)


Необходимое оборудование для рабочего места специалиста ОТК перечислено в [соответствующей статье](./analytics-workbench.md).
Исходный код модуля доступен по [сслыке](https://github.com/Multi-Agent-io/feecc-cameraman).

## Стек технологий

- Операционная система - [GNU/LINUX](https://www.gnu.org/), рекомендуется [Ubuntu](https://ubuntu.com/)
- Язык программирования - [Python](https://www.python.org/)
- ASGI-сервер - [Uvicorn](https://www.uvicorn.org/)
- REST-запросы - [FastAPI](https://fastapi.tiangolo.com/)
- ПО для развертывания - [Docker](https://www.docker.com/)
- База данных - [MongoDB](https://www.mongodb.com/)
- Кеширование данных для ускорения - [Redis](https://redis.io/)

## Установка

Приложение должно запускаться в контейнере Docker и может быть настроено путем установки нескольких переменных окружения.

> Обратите внимание, что в этом руководстве предполагается хост Linux(Ubuntu), однако вы также можете запустить аналитику
> на любой другой ОС, но имейте в виду: часовой пояс определяется из файлов хоста `/etc/timezone` и `/etc/localtime` внутри 
> контейнера, которые не присутствуют на компьютерах с Windows, в таком случае внутри контейнера будет время UTC.

Склонируйте репозиторий и измените переменные среды:
```
git clone https://github.com/Multi-Agent-io/feecc-analytics-backend
cd feecc-analytics-backend
vim docker-compose.yml
```

### Переменные среды

- `MONGO_CONNECTION_URL` — URI вашего подключения к MongoDB, заканчивающийся на `/db-name`.

- `SECRET_KEY` - 

[//]: # (TODO Што это?)

По окончании конфигурации, соберите и запустите контейнер с помощью docker-compose. 
```
sudo docker-compose up --build
```
Порт доступа по умолчанию - `5002`

Проверьте развертывание, перейдя по адресу http://127.0.0.1:8081/docs в браузере. Вы должны увидеть страницу спецификации SwaggerUI API.

[//]: # (TODO так ли это? )

## Описание модуля

### Эндпоинты

*Более подробная информация об эндпоинтах, включая все передаваемые параметры, размещена 
[здесь](http://analytics.netmvas.com:5002/docs).*

#### Группа `Passports (Units) Management`:

Группа отвечает за взаимодействие с паспортами изделий, выпуск, удаление, модификация.

###### `get` /api/v1/passports/
> Получение списка выпущенных паспортов с их содержимым. Так как количество паспортов велико, параметры запроса включают
> количество возвращаемых паспортов (`start:limit`)

###### `post` /api/v1/passports/    
> Создание нового паспорта.

###### `get` /api/v1/passports/types
> Получение списка всех возможных типов паспортов изделий.

###### `get` /api/v1/tcd/passports/{internal_id}
> Получение содержимого конкретного паспорта по его `id`.

###### `delete` /api/v1/tcd/passports/{internal_id}
> Удалить существующий паспорт изделия. 

###### `patch` /api/v1/tcd/passports/{internal_id}
> Редактирование полей паспорта. Некоторые поля (`"uuid", "internal_id", "is_in_db", "featured_in_int_id"`) неизменяемы,
> вместо данных в них необходимо вставлять `null`.

###### `post` /api/v1/tcd/passports/{internal_id}/serial
> Обновить серийный номер паспорта.

###### `post` /api/v1/tcd/passports/{internal_id}/revision
> Отправить паспорт изделия на ревизию.

[//]: # (TODO)

#### Группа `Quality Control Operations endpoints`:

Группа отвечает за взаимодействие с протоколами испытаний изделий.

###### `get` /api/v1/tcd/protocols
> Получение списка выпущенных протоколов с их содержимым.

###### `get` /api/v1/tcd/protocols/types    
> Получение списка всех возможных этапов протоколирования.

###### `get` /api/v1/tcd/protocols/{internal_id}
> Получение содержимого конкретного протокола по его `id`.

###### `post` /api/v1/tcd/protocols/{internal_id}
> Обновление содержимого протокола. Если Протокола нет, он будет создан, если протокол удтвержден, его нельзя изменить. 
> Необходимо удалить текущий и создать новый.

###### `delete` /api/v1/tcd/protocols/{internal_id}
> Удалить существующий протокол проверки. 

###### `post` /api/v1/tcd/protocols/{internal_id}/approve
> Утвердить протокол. Условие - прохождение изделием всех проверок.

#### Группа `Employees Management`:

Группа отвечает за взаимодействие с обектами инженеров в базе данных. Вся информация о сотрудниках в базе данных 
захешироавана, для поиска используется кеширование.

###### `get` /api/v1/employees/
> Получение списка всех сотрудников.

###### `post` /api/v1/employees/
> Добавить нового сотрудника.

###### `get` /api/v1/employees/{rfid_card_id}
> Получение информации о сотруднике по ID его пропуска RFID.

###### `delete` /api/v1/employees/{rfid_card_id}
> Удалить сотрудника из базы данных. 

###### `patch` /api/v1/tcd/passports/{rfid_card_id}
> Редактирование полей данных о сотруднике в базе данных.

###### `post` /api/v1/employees/decode
> Раскодирование данных о сотруднике из хеш-строки. Используется кеширование/перебор хеш-строк.

#### Группа `Production Schemas Management`:

Группа отвечает за взаимодействие со схемами производства изделий.

###### `get` /api/v1/schemas/
> Получение списка всех схем производства изделий. Задается количество схем на странице и количество страниц.

###### `post` /api/v1/schemas/
> Добавить новую производственную схему. Поле `schema_id` не заполнять, иначе схема перезапишется.

###### `get` /api/v1/schemas/{schema_id}
> Получение информации о схеме по ее ID.

###### `delete` /api/v1/schemas/{schema_id}
> Удалить схему из базы данных. 

###### `patch` /api/v1/schemas/{schema_id}
> Редактирование полей схемы. Некоторые изменения полей (`"schema_id", "parent_schema_id", 
> "required_components_schema_ids"`) применяться не будут.

#### Группа `Analytics Users Management`:

Группа отвечает за взаимодействие с объектами сотрудников отдела аналитики.

###### `get` /api/v1/users/me
> Получить информацию о текущем сотруднике отдела аналитики. Для идентификации используется токен.

###### `post` /api/v1/users/
> Создать нового сотрудника отдела аналитики.

###### `get` /api/v1/users/{username}
> Получить информацию о конкретном сотруднике отдела аналитики по его `username`.

###### `delete` /api/v1/users/{username}
> Удалить сотрудника отдела аналитики из базы данных по его `username`.

###### `patch` /api/v1/users/{username}
> Редактирование полей объекта сотрудника отдела аналитики.

#### Группа `Service Endpoints`:

Служебные эндпоинты.

###### `get` /api/v1/status
> Получить информацию о текущем статусе сервера.

###### `post` /token
> Эндпоинт для авторизации. Возвращает токен пользователя.

#### Группа `External Operations`:

Служебные эндпоинты.

###### `get` /api/v1/status
> Получить информацию о текущем статусе сервера.

###### `post` /token
> Эндпоинт для авторизации. Возвращает токен пользователя.

### Схемы структур данных 

Схемы структур данных представлены в нижней части [страницы](http://analytics.netmvas.com:5002/docs#/) API.

### Подмодули

[//]: # (TODO: Проверить)

Подмодуль `dependencies` содержит различные функции для работы пользователя с аналитикой:

  - `filters.py` отвечает за обработку фильтров для взаимодействия со списками объектов при обращении к эндпоинту.
  - `handlers.py` отвечает за обработку запроса на обновление протокола сборки.
  - `security.py` отвечает за логин пользователей в систему.

Остальные подмодули:

  - `database.py` содержит конкретные функции для взаимодействия с базой данных.
  - `exceptions.py` - определение исключений.
  - `models.py` определяет схемы структур данных.
  - `singleton.py` отвечает за то, что в любой момент времени только один инстанс конкретного класса доступен публично.
  - `types.py` определяет комплексные типизации.
  - `utils.py` отвечает за обработку файлов `.yml`.
# FEECC IPFS Gateway

> Feecc IPFS Gateway — это микросервис, предназначенный для публикации файлов в облаке IPFS и в сервисе Pinata. 
> Он также позволяет публиковать CID файлов в datalog Робономики. Сервис предоставляет простой интерфейс REST API для 
> публикации файлов либо по их путям на хосте, либо путем предоставления их в теле запроса. Сервис также обрабатывает 
> аутентификацию пользователей.

Необходимое оборудование для рабочего места инженера (далее - РМИ) перечислено в [соответствующей статье](./workbench-and-components.md).
Исходный код модуля доступен по [сслыке](https://github.com/Multi-Agent-io/feecc-ipfs-gateway).

## Стек технологий

- Операционная система - [Ubuntu](https://ubuntu.com/)
- Язык программирования - [Python](https://www.python.org/)
- ASGI-сервер - [Uvicorn](https://www.uvicorn.org/)
- REST-запросы - [FastAPI](https://fastapi.tiangolo.com/)
- Python3 HTTP-client - [httpx](https://www.python-httpx.org/)
- Сервис для публикации файлов на крупные ноды IPFS - [Pinata](https://www.pinata.cloud/)
- ПО для развертывания - [Docker](https://www.docker.com/)

## Установка

Приложение должно запускаться в контейнере Docker и может быть настроено путем установки нескольких переменных окружения.

> Обратите внимание, что в этом руководстве предполагается хост Linux(Ubuntu), однако вы также можете запустить Cameraman
> на любой другой ОС, но имейте в виду: часовой пояс определяется из файлов хоста `/etc/timezone` и `/etc/localtime` внутри 
> контейнера, которые не присутствуют на компьютерах с Windows, в таком случае внутри контейнера будет время UTC.

Склонируйте репозиторий и измените переменные среды:
```
git clone https://github.com/Multi-Agent-io/feecc-ipfs-gateway.git
cd feecc-cameraman
vim docker-compose.yml
```

### Переменные среды

- `MONGODB_URI` — URI вашего подключения к MongoDB, заканчивающийся на `/db-name`.

- `PRODUCTION_ENVIRONMENT` - оставьте `null`, если вы хотите провести тестирование учетных данных для работы, иначе `True`.

- `LOCAL_IPFS_ENABLED`- Публиковать или нет файлы в локальную сеть IPFS. По умолчанию - `false`.

- `PINATA_ENABLED`- Публиковать или нет файлы в сервис Pinata. По умолчанию - `false`.

- `PINATA_API`- API-код сервиса Pinata. Оставьте пустым, если не публикуете файлы в Pinata.

- `PINATA_SECRET_API`- Секретный API-код сервиса Pinata. Оставьте пустым, если не публикуете файлы в Pinata.

- `ROBONOMICS_ENABLE_DATALOG`- Публиковать или нет IPFS CID в datalog Робономики. По умолчанию - `false`.

- `ROBONOMICS_ACCOUNT_SEED`- Приватный ключ или сид-фраза кошелька на платформе Робономика. Оставьте пустым, если не публикуете данные в сеть.

По окончании конфигурации, соберите и запустите контейнер с помощью docker-compose. 
```
sudo docker-compose up --build
```

Проверьте развертывание, перейдя по адресу http://127.0.0.1:8082/docs в браузере. Вы должны увидеть страницу спецификации SwaggerUI API.

## Описание модуля

### Эндпоинты

Работа модуля заключается в обрабортке запросов к соответствующим эндпоинтам:

###### `post` /publish-to-ipfs/by-path  
> Опубликовать файл в локальную сеть IPFS и/или в сервис Pinata. Аргументом является абсолютный путь до файла.

###### `post` /publish-to-ipfs/upload-file
> Опубликовать файл в локальную сеть IPFS и/или в сервис Pinata. Аргументом является `fastapi.UploadFile`.

### Подмодули

Подмодуль `auth` отвечает за авторизацию пользователя, обращения к базе данных, а также за то, чтобы к камере был привязан
только один рабочий в каждый момент времени

Подмодуль `io_gateway` отвечает непосредственно за взаимодействие с камерой:

  - `dependencies.py` предоставляет функцию проверки существования файла по его пути.
  - `ipfs.py` отвечает за публикацию файлов в локальную сеть IPFS и/или в Pinata.
  - `models.py` описывает модели ответов на запросы.
  - `pinata.py` отвечает за взаимодействия с Pinata (пин файла на нодах сервиса)".